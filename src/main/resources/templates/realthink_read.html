<!DOCTYPE html>
<html lang="kr">
<head>
    {{> include/header}}
    <link rel="stylesheet" type="text/css" href="/style/user.css">

    <style>
        .backslash {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="0" x2="100%" y2="100%" stroke="red" /></svg>');
        }
        .slash {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="100%" x2="100%" y2="0" stroke="red" /></svg>');
        }
        .real-container {
            font-family: "Noto Sans KR", sans-serif;
            width: 1340px;
            padding: 20px;
        }

        .real-container-header {
            padding: 20px;
        }

        /* ------------------------------------------------- */
        #tabs {
            font-weight: bold;
            overflow: hidden;
            width: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        #tabs li {
            float: left;
            font-weight: normal;
            /*margin: 0 .5em 0 0;*/
        }

        #tabs a {
            position: relative;
            background: #ddd;
            background-image: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
            background-image: -webkit-linear-gradient(top, #fff, #ddd);
            background-image: -moz-linear-gradient(top, #fff, #ddd);
            background-image: -ms-linear-gradient(top, #fff, #ddd);
            background-image: -o-linear-gradient(top, #fff, #ddd);
            background-image: linear-gradient(to bottom, #fff, #ddd);
            padding: .7em 1.75em;
            float: left;
            text-decoration: none;
            color: #444;
            text-shadow: 0 1px 0 rgba(255, 255, 255, .8);
            -webkit-border-radius: 5px 0 0 0;
            -moz-border-radius: 5px 0 0 0;
            border-radius: 5px 0 0 0;
            -moz-box-shadow: 0 2px 2px rgba(0, 0, 0, .4);
            -webkit-box-shadow: 0 2px 2px rgba(0, 0, 0, .4);
            box-shadow: 0 2px 2px rgba(0, 0, 0, .4);
        }

        #tabs a:hover,
        #tabs a:hover::after,
        #tabs a:focus,
        #tabs a:focus::after {
            background: #fff;
        }

        #tabs a:focus {
            outline: 0;
        }

        #tabs a::after {
            content: '';
            position: absolute;
            z-index: 1;
            top: 0;
            right: -.5em;
            bottom: 0;
            width: 1em;
            background: #ddd;
            background-image: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
            background-image: -webkit-linear-gradient(top, #fff, #ddd);
            background-image: -moz-linear-gradient(top, #fff, #ddd);
            background-image: -ms-linear-gradient(top, #fff, #ddd);
            background-image: -o-linear-gradient(top, #fff, #ddd);
            background-image: linear-gradient(to bottom, #fff, #ddd);
            -moz-box-shadow: 2px 2px 2px rgba(0, 0, 0, .4);
            -webkit-box-shadow: 2px 2px 2px rgba(0, 0, 0, .4);
            box-shadow: 2px 2px 2px rgba(0, 0, 0, .4);
            -webkit-transform: skew(10deg);
            -moz-transform: skew(10deg);
            -ms-transform: skew(10deg);
            -o-transform: skew(10deg);
            transform: skew(10deg);
            -webkit-border-radius: 0 5px 0 0;
            -moz-border-radius: 0 5px 0 0;
            border-radius: 0 5px 0 0;
        }

        #tabs #current a,
        #tabs #current a::after {
            background: #fff;
            z-index: 3;
        }

        /* ------------------------------------------------- */
        #content {
            font-size: x-large;
            background: ghostwhite;
            padding: 2em;
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 2;
            -moz-border-radius: 0 5px 5px 5px;
            -webkit-border-radius: 0 5px 5px 5px;
            border-radius: 0 5px 5px 5px;
            -moz-box-shadow: 0 -2px 3px -2px rgba(0, 0, 0, .5);
            -webkit-box-shadow: 0 -2px 3px -2px rgba(0, 0, 0, .5);
            box-shadow: 0 -2px 3px -2px rgba(0, 0, 0, .5);
        }


    </style>
</head>
<body>
{{> include/navBar}}
<div class="container mt-5 mb-5"
     style="height: 960px;
     margin-left: 12%;
     /*margin-right: 20%;*/
     position:absolute; z-index: 2; display: none" id="transactionStatus">
    <div class="row justify-content-between" style="height: 40%">
        <div class="col-5 backslash">

        </div>
        <div class="col-5 slash">

        </div>
    </div>
    <div class="row text-center">
        <button id="transactionBtn" type="button" class="btn btn-danger mx-auto" disabled style="font-size:48px; z-index: auto">거래 중</button>
    </div>
    <div class="row justify-content-between" style="height: 40%">
        <div class="col-5 slash">

        </div>
        <div class="col-5 backslash">

        </div>
    </div>
</div>
<div class="container real-container shadow-lg mt-5 mb-5" style="z-index: 1">
    <div class="row real-container-header">
        <div class="col">
                <h1 class="display-4" style="font-weight: bolder">{{real.title}}</h1>
        </div>
        <div class="col-auto">
            <button id="transacionDone" type="button" class="btn btn-primary" style="pointer-events: none; display: none" >거래완료</button>
        </div>
        <div class="col-auto">
            <div>2020/04/12</div>
            <div class="text-gray-800" style="float: right"><i class="far fa-eye"></i>
                {{real.hit}}
            </div>
        </div>
    </div>
    <div class="dropdown-divider"></div>

    <div class="row">
        <ul id="tabs">
            <li><a href="#" title="tab1">개요</a></li>
            <li><a href="#" title="tab2">상세내용</a></li>
            <li><a href="#" title="tab3">기대효과</a></li>
            <li><a href="#" title="tab4">유사아이디어</a></li>
            <li><a href="#" title="tab5">차별성</a></li>
            <li><a href="#" title="tab6">특허관련</a></li>
            <li><a href="#" title="tab7">첨부파일</a></li>
        </ul>
    </div>
    <div class="row" style="height: 600px">
        <div id="content" class="shadow" style="z-index: 1">
            <div id="tab1">
                <p>{{realContent.outline}}</p>
            </div>
            <div id="tab2">
                <p>{{realContent.content}}</p>
            </div>
            <div id="tab3">
                <p>{{realContent.effect}}</p>
            </div>
            <div id="tab4">
                <p>{{realContent.similar}}</p>
            </div>
            <div id="tab5">
                <p>{{realContent.difference}}</p>
            </div>
            <div id="tab6">
                <p>{{realContent.patent}}</p>
            </div>
        </div>
    </div>
    <div class="dropdown-divider mt-2"></div>

    <div class="row justify-content-between">
        <div class="col-auto ml-3">
            <div class="row">
                <div id="priceInfo" class="col-auto shadow border-left-warning card mr-5" style="padding: 20px">
                    <div class="mx-auto mt-1 text-gray-500">
                        희망가격
                    </div>
                    <div class="row ml-2" style="font-size: x-large">
                        {{realContent.price}}<i class="mt-2 ml-2 mr-4 fas fa-won-sign"></i>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <a id="buyer" class="shadow border-left-primary card small"
                   style="padding: 20px; text-decoration: none; color: black; display: none">
                    <div class="mx-auto mt-1 text-gray-500">
                        구매자
                    </div>
                    <div class="mx-auto text-gray-900">
                        <div id="buyerNick" class="h1"></div>
                    </div>
                </a>

                <a id="msgBtn" href="/user/mypage/message" class="btn btn-info btn-icon-split shadow">
                    <span class="icon text-white-50">
<i class="fas fa-paper-plane"></i>
                    </span>
                    <span class="text">쪽지보내기</span>
                </a>

                <a id="buyBtn" class="ml-3 btn btn-warning btn-icon-split shadow" onclick="buyBtnClick()">
                    <span class="icon text-white-50">
                        <i class="fas fa-won-sign"></i>
                    </span>
                    <span class="text">구매하기</span>
                </a>
            </div>
        </div>

        <div class="col-auto justify-content-end mr-4">
            <a href="/user?id={{real.user.id}}" class="shadow border-left-secondary card small"
               style="padding: 20px; text-decoration: none; color: black">
                <div class="mx-auto mt-1 text-gray-500">
                    작성자
                </div>
                <div class="mx-auto text-gray-900">
                    <div class="h1">{{real.user.nick}}</div>
                </div>
                <div class="row justify-content-center">
                    <i class="fas fa-star" style="color:gold"></i>
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                </div>
            </a>
        </div>
    </div>
</div>
<div class="modal" tabindex="-1" role="dialog" id="TransactionModal">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">거래 창</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h1 class="display-4 text-center" style="color: red">★주의★</h1>
                <div class="dropdown-divider"></div>
                <div class="text-center" style="font-weight: bold">
                거래완료시 지식 재산권이 해당 유저에게 넘어갑니다.<br>
                거절하고 싶으시면 거절을 눌러주세요.<br>
                나중에 거래를 결정하고 싶으시면 오른쪽 상단의 X를 눌러주세요.
                </div>
                <div class="dropdown-divider"></div>
                <div class="text-center">유저가 제시한 금액</div>
                <div class="text-center">
                    <button id="userPrice" type="button" class="btn btn-outline-info" style="pointer-events: none">5000원</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="transactionReject()">거절</button>
                <button type="button" class="btn btn-primary" onclick="transactionAccept()">거래완료</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" tabindex="-1" role="dialog" id="InputPriceModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">희망가격 입력</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">$</span>
                    </div>
                    <input type="number" class="form-control" aria-label="Amount (to the nearest dollar)" id="InputPrice" min="0">
                    <div class="input-group-append">
                        <span class="input-group-text">원</span>
                    </div>
                </div>
                <div id="buyerAlert" style="display: none">
                    <div class="vertical-divider"></div>
                    <div style="color: red">포인트가 부족합니다</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="modalBuyBtn" disabled onclick="modalBuyBtnClick()">구매 신청</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
<div id="ratingModal" class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">판매자를 평가해주세요!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mx-auto">
                    <div class="col-6">
                        <input required class="mx-auto" type="number" max="5.0" min="0" id="InputRating" style="font-size: x-large">
                    </div>
                    <div class="col"><h3>/5.0</h3></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="ratingBtn" onclick="ratingModalBtnClick()">확인</button>
            </div>
        </div>
    </div>
</div>
<script>
    let postId = {{real.id}}
    let writer = {{real.user.writer}}

    let price = 0
    //상태 읽기
    $.ajax({
        type: "GET",
        url: "/check/transaction?postId=" + postId,
        success : function (data) {
            if (data === '') {
                $('#transactionStatus').css('display', 'none')
                if (writer) {
                    $('#buyBtn').css('display', 'none')
                    $('#msgBtn').css('display', 'none')
                }
            }else if(data['status'] === true){
                $('#transactionStatus').css('display', 'none')
                $('#buyBtn').css('display', 'none')
                $('#msgBtn').css('display', 'none')
                $('#priceInfo').css('display', 'none')
                $('#transacionDone').css('display', '')
                $('#buyer').css('display', '')
                $('#buyerNick').text(data['buyer']['nick'])
                console.log(data['buyerCheck'])
                if(data['buyerCheck']){
                    $('#ratingModal').modal('show',true)
                }
            }else{
                $('#transactionStatus').css('display', '')
                $('#buyBtn').css('display', 'none')
                $('#msgBtn').css('display', 'none')
                price = data['price']
                $('#userPrice').text(data['price']+"원")
                if(writer){
                    $('#transactionBtn')
                        .removeClass("btn-danger").addClass("btn-primary")
                        .removeAttr("disabled")
                        .text("거래진행하기")
                        .click(function () {
                            $('#TransactionModal').modal('show', true)
                        })
                }
            }
        }
    })

    //구매 클릭
    function buyBtnClick(){
        $('#InputPriceModal').modal('show')
    }

    //구매 동의
    function transactionAccept(){
        $.ajax({
            type: "PUT",
            url: "/update/transaction?postId=" + postId,
            contentType: 'application/json;charset=UTF-8',
            dataType: 'json',
            data : {
                'price': price
            },
            success : function () {
                location.reload()
            }
        })
    }

    //구매 거절
    function transactionReject(){
        $.ajax({
            type: "DELETE",
            url: "/delete/transaction?postId=" + postId,
            contentType: 'application/json;charset=UTF-8',
            dataType: 'json',
            data : {
                'price': price
            },
            success : function () {
                location.reload()
            }
        })
    }

    //구매 모달
    $(function () {
        $('#InputPrice').keyup(function (event) {
            let price = $('#InputPrice').val()
            if(price < 0){
                $('#modalBuyBtn').attr("disabled", "disabled")
            }else{
                $('#modalBuyBtn').removeAttr("disabled")
            }
        })
    })

    //구매 요청
    function modalBuyBtnClick() {
        let price = $('#InputPrice').val()
        $.ajax({
            type: "POST",
            url: "/create/transaction",
            contentType: 'application/json;charset=UTF-8',
            dataType: 'json',
            data: JSON.stringify({
                "price" : price,
                "post" : {
                    "id" : postId
                },
            }),
            success : function (data) {
                if(data===false){
                    $('#buyerAlert').css('display', '')
                }else{
                    location.reload()
                }
            }
        })
    }

    let user = {{real.user.id}}
    function ratingModalBtnClick(){
        let rating = $('#InputRating').val()
        if(rating>5){
            rating = 5
        }else if(rating<0){
            rating = 0
        }
        $.ajax({
            type: "POST",
            url: "/create/rate",
            contentType: 'application/json;charset=UTF-8',
            dataType: 'json',
            data: JSON.stringify({
                "score" : rating,
                "user" : user
            }),
            complete : function (data) {
               $('#ratingModal').modal('hide')
            }
        })
    }




    $(document).ready(function () {
        $("#content div").hide() // Initially hide all content
        $("#tabs li:first").attr("id", "current") // Activate first tab
        $("#content div:first").fadeIn() // Show first tab content

        $('#tabs a').click(function (e) {
            e.preventDefault()
            $("#content div").hide() //Hide all content
            $("#tabs li").attr("id", "") //Reset id's
            $(this).parent().attr("id", "current") // Activate this
            $('#' + $(this).attr('title')).fadeIn() // Show content for current tab
        })
    })
</script>
</body>
<footer>
    {{> /include/footer}}
</footer>
</html>
